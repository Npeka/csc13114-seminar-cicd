name: CI Lint, Test and Typecheck

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]

permissions:
    contents: read

jobs:
    backend:
        name: Backend - lint, test, coverage, typecheck
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "pnpm"

            - name: Enable Corepack and pnpm
              run: |
                  corepack enable
                  corepack prepare pnpm@latest --activate

            - name: Install backend dependencies
              run: pnpm install --prefix backend --frozen-lockfile

            - name: Lint backend
              run: pnpm --prefix backend run lint

            - name: Typecheck backend (tsc --noEmit)
              run: pnpm --prefix backend exec tsc --noEmit

            - name: Run backend tests with coverage
              run: pnpm --prefix backend run test:cov

            - name: Upload backend coverage
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: backend-coverage
                  path: backend/coverage

    frontend:
        name: Frontend - lint, typecheck, tests (if present)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "pnpm"

            - name: Enable Corepack and pnpm
              run: |
                  corepack enable
                  corepack prepare pnpm@latest --activate

            - name: Install frontend dependencies
              run: pnpm install --prefix frontend --frozen-lockfile

            - name: Lint frontend
              run: pnpm --prefix frontend run lint

            - name: Typecheck frontend (tsc --noEmit, fallback build nếu không có TS)
              run: pnpm --prefix frontend exec tsc --noEmit || pnpm --prefix frontend run build

            - name: Run frontend tests if present
              shell: bash
              run: |
                  if jq -e '.scripts.test' frontend/package.json >/dev/null; then
                    pnpm --prefix frontend run test
                  else
                    echo "No frontend tests defined"
                  fi

            - name: Upload frontend coverage (if generated)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-coverage
                  path: frontend/coverage
