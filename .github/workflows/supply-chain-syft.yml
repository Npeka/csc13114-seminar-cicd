name: Supply Chain - SBOM, Scan & Policy

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  actions: read
  security-events: write
  # cần để deploy GitHub Pages
  pages: write
  # cần cho actions/deploy-pages
  id-token: write

jobs:
  generate_sbom_and_scan:
    name: Generate SBOM, Scan Images, and Policy-as-Code
    # Chỉ chạy nếu workflow build/push images success
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    environment: production
    env:
      REGISTRY: docker.io
      IMAGE_TAG: ${{ github.event.workflow_run.head_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 1) Install Syft
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.17.3

      # 2) Generate SBOM cho frontend (SPDX JSON)
      - name: Generate SBOM (frontend)
        env:
          IMAGE_PREFIX: docker.io/${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          syft \
            $IMAGE_PREFIX/csc13114-frontend:$IMAGE_TAG \
            -o spdx-json > sbom-frontend.spdx.json

      # 3) Generate SBOM cho backend (SPDX JSON)
      - name: Generate SBOM (backend)
        env:
          IMAGE_PREFIX: docker.io/${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          syft \
            $IMAGE_PREFIX/csc13114-backend:$IMAGE_TAG \
            -o spdx-json > sbom-backend.spdx.json

      # 4) Trivy scan: frontend image (fail nếu HIGH/CRITICAL, lưu thêm report table)
      - name: Trivy scan (frontend image)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/csc13114-frontend:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          format: table
          output: trivy-frontend-table.txt
          # Nếu có HIGH/CRITICAL → step này fail (gate)
          exit-code: "1"

      # 5) Trivy scan: backend image (fail nếu HIGH/CRITICAL, lưu thêm report table)
      - name: Trivy scan (backend image)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/csc13114-backend:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          format: table
          output: trivy-backend-table.txt
          # Nếu có HIGH/CRITICAL → step này fail (gate)
          exit-code: "1"

      # 6) Trivy SARIF report (frontend) để push lên Code Scanning
      - name: Trivy SARIF (frontend)
        if: always()
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/csc13114-frontend:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-frontend.sarif
          severity: HIGH,CRITICAL
          exit-code: "0" # không fail job ở bước tạo SARIF

      # 7) Trivy SARIF (backend)
      - name: Trivy SARIF (backend)
        if: always()
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/csc13114-backend:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-backend.sarif
          severity: HIGH,CRITICAL
          exit-code: "0"

      # 8) Upload Trivy SARIF (frontend) vào GitHub Code Scanning
      - name: Upload Trivy SARIF (frontend) to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-frontend.sarif
          category: trivy-frontend

      # 8b) Upload Trivy SARIF (backend) vào GitHub Code Scanning
      - name: Upload Trivy SARIF (backend) to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-backend.sarif
          category: trivy-backend

      # 9) Policy-as-code với Conftest trên SBOM
      - name: Setup Conftest
        if: always()
        uses: princespaghetti/setup-conftest@v1

      - name: Run Conftest policies on SBOM
        if: always()
        # Lưu output dạng table ra file để render vào HTML
        run: |
          conftest test \
            sbom-frontend.spdx.json \
            sbom-backend.spdx.json \
            -p policy \
            -o table | tee conftest-sbom-table.txt

      # 10) Upload SBOM artifacts (giữ lại file JSON thô)
      - name: Upload SBOM artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: |
            sbom-frontend.spdx.json
            sbom-backend.spdx.json

      # 11) Tạo static site cho các report (SBOM / Trivy / Conftest)
      - name: Prepare supply chain reports site
        if: always()
        run: |
          mkdir -p site/sbom site/trivy site/policy

          # Copy SBOM JSON để có thể tải/xem trực tiếp
          cp sbom-frontend.spdx.json site/sbom/
          cp sbom-backend.spdx.json site/sbom/

          # Tạo HTML cho Trivy frontend
          cat > site/trivy/frontend.html << 'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <title>Trivy report - frontend image</title>
          </head>
          <body>
            <h1>Trivy report - frontend image</h1>
            <pre>
          EOF
          cat trivy-frontend-table.txt >> site/trivy/frontend.html
          cat >> site/trivy/frontend.html << 'EOF'
            </pre>
          </body>
          </html>
          EOF

          # Tạo HTML cho Trivy backend
          cat > site/trivy/backend.html << 'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <title>Trivy report - backend image</title>
          </head>
          <body>
            <h1>Trivy report - backend image</h1>
            <pre>
          EOF
          cat trivy-backend-table.txt >> site/trivy/backend.html
          cat >> site/trivy/backend.html << 'EOF'
            </pre>
          </body>
          </html>
          EOF

          # Tạo HTML cho kết quả Conftest
          cat > site/policy/conftest.html << 'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <title>Conftest policy results</title>
          </head>
          <body>
            <h1>Conftest policy results on SBOM</h1>
            <pre>
          EOF
          cat conftest-sbom-table.txt >> site/policy/conftest.html
          cat >> site/policy/conftest.html << 'EOF'
            </pre>
          </body>
          </html>
          EOF

          # Trang index đơn giản để điều hướng
          cat > site/index.html << 'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <title>Supply chain reports</title>
          </head>
          <body>
            <h1>Supply chain reports</h1>
            <ul>
              <li><a href="sbom/sbom-frontend.spdx.json">SBOM - frontend (SPDX JSON)</a></li>
              <li><a href="sbom/sbom-backend.spdx.json">SBOM - backend (SPDX JSON)</a></li>
              <li><a href="trivy/frontend.html">Trivy scan - frontend image</a></li>
              <li><a href="trivy/backend.html">Trivy scan - backend image</a></li>
              <li><a href="policy/conftest.html">Conftest policy results</a></li>
            </ul>
          </body>
          </html>
          EOF

          # In cấu trúc site để debug
          ls -R site

      # 12) Upload static site làm Pages artifact
      - name: Upload supply chain reports Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  # Job deploy static site lên GitHub Pages
  deploy_supply_chain_reports:
    name: Deploy supply chain reports to GitHub Pages
    needs: generate_sbom_and_scan
    runs-on: ubuntu-latest
    # Luôn chạy sau generate_sbom_and_scan (kể cả khi job đó fail),
    # nhưng chỉ khi workflow build/push ban đầu là success
    if: always() && github.event.workflow_run.conclusion == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Print supply chain report URLs
        run: |
          echo "Supply chain reports base URL: ${{ steps.deployment.outputs.page_url }}"
          echo "SBOM (frontend):   ${{ steps.deployment.outputs.page_url }}sbom/sbom-frontend.spdx.json"
          echo "SBOM (backend):    ${{ steps.deployment.outputs.page_url }}sbom/sbom-backend.spdx.json"
          echo "Trivy frontend:    ${{ steps.deployment.outputs.page_url }}trivy/frontend.html"
          echo "Trivy backend:     ${{ steps.deployment.outputs.page_url }}trivy/backend.html"
          echo "Conftest results:  ${{ steps.deployment.outputs.page_url }}policy/conftest.html"
